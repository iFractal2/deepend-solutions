<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Pool Chemistry Calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
  :root {
    --bg: #e8eef5;
    --card-bg: #ffffff;
    --primary: #1e3a8a;
    --primary-dark: #1e40af;
    --primary-light: #3b82f6;
    --primary-glow: rgba(30, 58, 138, 0.15);
    --success: #059669;
    --warning: #d97706;
    --danger: #dc2626;
    --text: #1e293b;
    --text-light: #64748b;
    --border: #cbd5e1;
    --radius: 12px;
    --shadow: 0 2px 4px rgba(30, 58, 138, 0.08), 0 1px 2px rgba(30, 58, 138, 0.06);
    --shadow-lg: 0 10px 20px rgba(30, 58, 138, 0.15), 0 4px 8px rgba(30, 58, 138, 0.1);
    --shadow-hover: 0 8px 16px rgba(30, 58, 138, 0.2), 0 3px 6px rgba(30, 58, 138, 0.12);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', sans-serif;
  }

  * {
    transition: background-color 0.3s ease, border-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    padding: 0;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
  }

  .header {
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #2563eb 100%);
    color: #fff;
    padding: 12px 16px;
    text-align: center;
    box-shadow: var(--shadow-lg);
    position: sticky;
    top: 0;
    z-index: 100;
    animation: slideDown 0.5s ease-out;
  }

  @keyframes slideDown {
    from {
      transform: translateY(-100%);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .header h1 {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 700;
    letter-spacing: -0.5px;
  }

  .header p {
    margin: 3px 0 0;
    font-size: 0.75rem;
    opacity: 0.9;
  }

  .app {
    max-width: 1200px;
    margin: 0 auto;
    padding: 12px 8px;
  }

  .calculator-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 12px;
    align-items: start;
  }

  .calculator-grid .card {
    height: 100%;
  }

  /* Mobile responsive - stack vertically and increase sizes */
  @media (max-width: 768px) {
    .app {
      padding: 16px;
    }

    .calculator-grid {
      grid-template-columns: 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    .chemistry-grid-header {
      display: grid;
      grid-template-columns: 1.35fr 0.6fr 1.35fr;
      gap: 10px;
      padding: 12px 0;
      margin-bottom: 12px;
      font-size: 0.85rem;
    }

    .parameter-label {
      font-size: 0.95rem;
      font-weight: 700;
      padding: 0 6px;
      margin: 0;
      text-align: center;
      color: var(--primary);
      display: block;
      line-height: 1.4;
    }

    .chemistry-row {
      display: grid;
      grid-template-columns: 1.35fr 0.6fr 1.35fr;
      gap: 10px;
      align-items: center;
      padding: 12px 0;
      margin: 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .chemistry-row:last-child {
      border-bottom: none;
    }

    .slider-cell {
      margin-bottom: 0;
      gap: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
    }

    .slider-cell:last-child {
      margin-bottom: 0;
    }

    .slider-cell::before {
      display: none;
    }

    .slider-cell strong {
      font-size: 1rem;
      padding: 4px 10px;
      min-width: 50px;
      align-self: center;
    }

    .slider-cell input[type="range"] {
      height: 12px;
      margin: 6px 0;
      padding: 0;
      width: 100%;
      border-radius: 999px;
    }

    .slider-cell input[type="range"]::-webkit-slider-thumb {
      width: 20px;
      height: 20px;
    }

    .slider-cell input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
    }

    .card {
      padding: 20px;
      margin-bottom: 16px;
    }

    .card h2 {
      font-size: 1.2rem;
      margin-bottom: 16px;
    }

    .card h2::before {
      width: 4px;
      height: 22px;
    }

    label {
      font-size: 0.95rem;
      margin-bottom: 8px;
    }

    input[type="number"],
    select {
      padding: 14px 16px;
      font-size: 1rem;
      min-height: 50px;
    }

    .row {
      gap: 12px;
      margin-bottom: 16px;
    }

    .input-group {
      margin-bottom: 16px;
    }

    .result-box,
    .target-result {
      padding: 20px;
    }

    .result-box .lsi-value {
      font-size: 2.5rem;
    }

    .result-box .lsi-status {
      font-size: 1.1rem;
    }

    .result-box .lsi-details {
      font-size: 0.9rem;
    }

    .target-result .target-lsi {
      font-size: 2rem;
    }

    .target-result .target-status {
      font-size: 1rem;
    }

    .bar {
      height: 32px;
    }

    .bar-indicator {
      width: 4px;
      height: 40px;
      top: -4px;
    }

    .bar-labels {
      font-size: 0.8rem;
      margin-top: 8px;
    }

    .bar-container {
      margin: 16px 0;
    }

    .slider-group {
      margin-bottom: 20px;
    }

    .slider-label {
      margin-bottom: 8px;
    }

    .slider-label span {
      font-size: 0.95rem;
    }

    .slider-label strong {
      font-size: 1.1rem;
      padding: 4px 12px;
      min-width: 50px;
    }

    input[type="range"] {
      height: 12px;
      padding: 0;
      margin: 6px 0;
      background: linear-gradient(to right, var(--border) 0%, var(--primary-light) 50%, var(--border) 100%);
      box-shadow: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      width: 20px;
      height: 20px;
      box-shadow: 0 1px 4px rgba(30, 58, 138, 0.3);
    }

    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      box-shadow: 0 1px 4px rgba(30, 58, 138, 0.3);
    }

    .info-badge {
      font-size: 0.85rem;
      padding: 6px 12px;
      margin-top: 8px;
    }

    .dosage-item {
      padding: 16px;
      margin-bottom: 12px;
    }

    .dosage-item h4 {
      font-size: 1rem;
      margin-bottom: 8px;
    }

    .dosage-amount {
      font-size: 1.5rem;
    }

    .dosage-note {
      font-size: 0.85rem;
    }

    .header h1 {
      font-size: 1.3rem;
    }

    .header p {
      font-size: 0.85rem;
    }

    .header {
      padding: 16px;
    }
  }

  @media (max-width: 480px) {
    .app {
      padding: 14px;
    }

    .calculator-grid {
      gap: 14px;
    }

    .card {
      padding: 18px;
    }

    .card h2 {
      font-size: 1.15rem;
      margin-bottom: 16px;
    }

    .card h2::before {
      width: 3px;
      height: 20px;
    }

    .chemistry-row {
      padding: 12px 0;
      margin: 0;
      grid-template-columns: 1.25fr 0.5fr 1.25fr;
      gap: 8px;
    }

    .parameter-label {
      font-size: 1rem;
      padding: 0 6px;
      margin: 0;
    }

    .slider-cell {
      gap: 6px;
      margin-bottom: 0;
    }

    .slider-cell::before {
      display: none;
    }

    .slider-cell strong {
      font-size: 0.95rem;
      padding: 3px 8px;
      min-width: 45px;
    }

    .slider-cell input[type="range"] {
      height: 10px;
      margin: 6px 0;
      padding: 0;
      width: 100%;
      border-radius: 999px;
    }

    .slider-cell input[type="range"]::-webkit-slider-thumb {
      width: 18px;
      height: 18px;
      box-shadow: 0 1px 4px rgba(30, 58, 138, 0.3);
    }

    .slider-cell input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      box-shadow: 0 1px 4px rgba(30, 58, 138, 0.3);
    }

    label {
      font-size: 0.95rem;
    }

    input[type="number"],
    select {
      padding: 12px 14px;
      font-size: 0.95rem;
      min-height: 48px;
    }

    .result-box .lsi-value {
      font-size: 2.2rem;
    }

    .result-box .lsi-status {
      font-size: 1rem;
    }

    .result-box .lsi-details {
      font-size: 0.85rem;
    }

    .target-result .target-lsi {
      font-size: 1.8rem;
    }

    .target-result .target-status {
      font-size: 0.95rem;
    }

    .bar {
      height: 30px;
    }

    .bar-indicator {
      width: 4px;
      height: 38px;
      top: -4px;
    }

    .bar-labels span {
      font-size: 0.75rem;
      line-height: 1.3;
    }

    .slider-label span {
      font-size: 0.9rem;
    }

    .slider-label strong {
      font-size: 1.05rem;
      padding: 4px 10px;
      min-width: 48px;
    }

    .slider-group {
      margin-bottom: 18px;
    }

    .header h1 {
      font-size: 1.2rem;
    }

    .header p {
      font-size: 0.8rem;
    }

    .dosage-item h4 {
      font-size: 0.95rem;
    }

    .dosage-amount {
      font-size: 1.4rem;
    }

    .dosage-note {
      font-size: 0.8rem;
    }
  }

  .card {
    background: var(--card-bg);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 12px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
    animation: fadeInUp 0.6s ease-out;
    animation-fill-mode: both;
  }

  .card:hover {
    box-shadow: var(--shadow-hover);
    transform: translateY(-2px);
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .calculator-grid .card:nth-child(1) {
    animation-delay: 0.1s;
  }

  .calculator-grid .card:nth-child(2) {
    animation-delay: 0.2s;
  }

  .dosage-card {
    animation-delay: 0.3s;
  }

  .card h2 {
    margin: 0 0 12px;
    font-size: 1.1rem;
    font-weight: 700;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card h2::before {
    content: '';
    width: 3px;
    height: 20px;
    background: var(--primary);
    border-radius: 2px;
  }

  .input-group {
    margin-bottom: 10px;
  }

  .input-group:last-child {
    margin-bottom: 0;
  }

  label {
    display: block;
    font-weight: 600;
    font-size: 0.8rem;
    color: var(--text);
    margin-bottom: 4px;
  }

  input[type="number"],
  select {
    width: 100%;
    padding: 8px 10px;
    font-size: 0.9rem;
    border-radius: 8px;
    border: 2px solid var(--border);
    background: #fff;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-family: inherit;
    font-weight: 500;
    color: var(--text);
  }

  input[type="number"]:hover,
  select:hover {
    border-color: var(--primary-light);
    background: #f8fafc;
  }

  input[type="number"]:focus,
  select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px var(--primary-glow);
    background: #fff;
    transform: scale(1.01);
  }

  input[type="number"]:active,
  select:active {
    transform: scale(0.99);
  }

  .row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 10px;
  }

  .row:last-child {
    margin-bottom: 0;
  }

  @media (max-width: 600px) {
    .row {
      grid-template-columns: 1fr;
      gap: 10px;
    }
  }

  .result-box {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    padding: 12px;
    border-radius: var(--radius);
    border: 2px solid var(--primary-light);
    text-align: center;
    margin-bottom: 10px;
    transition: all 0.4s ease;
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% {
      box-shadow: 0 0 0 0 rgba(30, 58, 138, 0.4);
    }
    50% {
      box-shadow: 0 0 0 8px rgba(30, 58, 138, 0);
    }
  }

  .result-box .lsi-value {
    font-size: 2rem;
    font-weight: 800;
    line-height: 1;
    margin-bottom: 6px;
  }

  .result-box .lsi-status {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 8px;
  }

  .result-box .lsi-details {
    font-size: 0.75rem;
    color: var(--text-light);
  }

  .bar-container {
    margin: 12px 0;
  }

  .bar {
    height: 24px;
    border-radius: 12px;
    background: linear-gradient(90deg,
      #dc2626 0%, #dc2626 20%,
      #d97706 30%, #d97706 40%,
      #059669 45%, #059669 55%,
      #d97706 60%, #d97706 70%,
      #dc2626 80%, #dc2626 100%);
    position: relative;
    box-shadow: inset 0 2px 8px rgba(0,0,0,0.15);
    overflow: hidden;
  }

  .bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shimmer 3s infinite;
  }

  @keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
  }

  .bar-indicator {
    position: absolute;
    top: -4px;
    width: 3px;
    height: 32px;
    background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
    border-radius: 3px;
    transform: translateX(-50%);
    box-shadow: 0 2px 8px rgba(30, 58, 138, 0.6), 0 0 0 2px #fff;
    transition: left 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 10;
  }

  .bar-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--text-light);
    margin-top: 6px;
  }


  .slider-group {
    margin-bottom: 12px;
  }

  .slider-group:last-child {
    margin-bottom: 0;
  }

  .slider-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
  }

  .slider-label span {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text);
  }

  .slider-label strong {
    font-size: 0.95rem;
    color: var(--primary);
    padding: 2px 8px;
    background: var(--primary-glow);
    border-radius: 6px;
    transition: all 0.3s ease;
    display: inline-block;
    font-weight: 700;
    cursor: text;
    min-width: 40px;
    text-align: center;
    user-select: text;
    -webkit-user-select: text;
  }

  .slider-label strong:focus {
    outline: 2px solid var(--primary);
    background: #fff;
  }

  .slider-label strong[contenteditable]:empty::before {
    content: attr(data-placeholder);
    color: var(--text-light);
  }

  .slider-label strong.updating {
    animation: valueChange 0.3s ease;
  }

  @keyframes valueChange {
    0%, 100% {
      transform: scale(1);
      background: var(--primary-glow);
    }
    50% {
      transform: scale(1.1);
      background: rgba(30, 58, 138, 0.25);
    }
  }

  /* Chemistry Grid Layout */
  .chemistry-grid-header {
    display: grid;
    grid-template-columns: minmax(0, 1.25fr) minmax(120px, 160px) minmax(0, 1.25fr);
    gap: 20px;
    padding: 12px 0;
    border-bottom: 2px solid var(--border);
    margin-bottom: 16px;
    text-align: center;
    font-weight: 700;
    font-size: 0.9rem;
    color: var(--primary);
  }

  .header-current,
  .header-target {
    font-size: 0.85rem;
  }

  .header-parameter {
    min-width: 0;
    white-space: normal;
    line-height: 1.3;
  }

  .chemistry-row {
    display: grid;
    grid-template-columns: minmax(0, 1.25fr) minmax(120px, 160px) minmax(0, 1.25fr);
    gap: 20px;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
  }

  .chemistry-row:last-child {
    border-bottom: none;
  }

  .parameter-label {
    text-align: center;
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--text);
    min-width: 0;
    padding: 0 12px;
    white-space: normal;
    line-height: 1.35;
  }

  .slider-cell {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .slider-cell strong {
    font-size: 1rem;
    color: var(--primary);
    padding: 4px 10px;
    background: var(--primary-glow);
    border-radius: 6px;
    text-align: center;
    font-weight: 700;
    cursor: text;
    min-width: 45px;
    align-self: center;
    user-select: text;
    -webkit-user-select: text;
  }

  .slider-cell strong:focus {
    outline: 2px solid var(--primary);
    background: #fff;
  }

  .slider-cell input[type="range"] {
    width: 100%;
  }

  input[type="range"] {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: linear-gradient(to right, var(--border) 0%, var(--primary-light) 50%, var(--border) 100%);
    outline: none;
    -webkit-appearance: none;
    appearance: none;
    cursor: pointer;
  }

  input[type="range"]:hover {
    background: linear-gradient(to right, var(--primary-light) 0%, var(--primary) 50%, var(--primary-light) 100%);
  }

  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    cursor: grab;
    box-shadow: 0 2px 8px rgba(30, 58, 138, 0.4);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 3px solid #fff;
  }

  input[type="range"]::-webkit-slider-thumb:hover {
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-light) 100%);
    transform: scale(1.2);
    box-shadow: 0 4px 12px rgba(30, 58, 138, 0.6);
  }

  input[type="range"]::-webkit-slider-thumb:active {
    cursor: grabbing;
    transform: scale(1.1);
    box-shadow: 0 2px 6px rgba(30, 58, 138, 0.5);
  }

  input[type="range"]::-moz-range-thumb {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    cursor: grab;
    border: 3px solid #fff;
    box-shadow: 0 2px 8px rgba(30, 58, 138, 0.4);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  input[type="range"]::-moz-range-thumb:hover {
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-light) 100%);
    transform: scale(1.2);
    box-shadow: 0 4px 12px rgba(30, 58, 138, 0.6);
  }

  input[type="range"]::-moz-range-thumb:active {
    cursor: grabbing;
    transform: scale(1.1);
  }

  .target-result {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    padding: 12px;
    border-radius: var(--radius);
    border: 2px solid var(--success);
    text-align: center;
    transition: all 0.4s ease;
  }

  .target-result:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
  }

  .target-result .target-lsi {
    font-size: 1.5rem;
    font-weight: 800;
    line-height: 1;
    margin-bottom: 6px;
  }

  .target-result .target-status {
    font-size: 0.9rem;
    font-weight: 600;
  }

  .dosage-card {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 2px solid #d97706;
    position: relative;
    overflow: hidden;
  }

  .dosage-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    animation: shimmer 4s infinite;
  }

  .dosage-item {
    background: #fff;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 8px;
    border-left: 3px solid var(--primary);
    transition: all 0.3s ease;
    animation: slideInLeft 0.5s ease-out;
    animation-fill-mode: both;
  }

  .dosage-item:nth-child(1) { animation-delay: 0.1s; }
  .dosage-item:nth-child(2) { animation-delay: 0.2s; }
  .dosage-item:nth-child(3) { animation-delay: 0.3s; }

  @keyframes slideInLeft {
    from {
      opacity: 0;
      transform: translateX(-30px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  .dosage-item:hover {
    transform: translateX(8px);
    box-shadow: -4px 0 0 var(--primary), 0 4px 12px rgba(30, 58, 138, 0.15);
  }

  .dosage-item:last-child {
    margin-bottom: 0;
  }

  .dosage-item h4 {
    margin: 0 0 6px;
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--text);
  }

  .dosage-amount {
    font-size: 1.3rem;
    font-weight: 800;
    color: var(--primary);
    margin: 4px 0;
  }

  .dosage-note {
    font-size: 0.7rem;
    color: var(--text-light);
    margin-top: 4px;
  }

  .status-balanced {
    color: var(--success);
  }

  .status-warning {
    color: var(--warning);
  }

  .status-danger {
    color: var(--danger);
  }

  .info-badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    margin-top: 6px;
    transition: all 0.3s ease;
    animation: fadeIn 0.5s ease-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .badge-success {
    background: #d1fae5;
    color: #065f46;
  }

  .badge-warning {
    background: #fef3c7;
    color: #92400e;
  }

  .badge-danger {
    background: #fee2e2;
    color: #991b1b;
  }

  .no-dosage {
    text-align: center;
    color: var(--text-light);
    padding: 16px;
    font-size: 0.85rem;
  }

  @keyframes flashRed {
    0%, 100% {
      filter: none;
    }
    50% {
      filter: drop-shadow(0 0 8px rgba(220, 38, 38, 0.8));
    }
  }

.flash-error {
  animation: flashRed 0.4s ease-in-out;
}

.info-blurb {
  margin: 0 0 12px;
  padding: 12px 14px;
  background: rgba(30, 58, 138, 0.08);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  color: var(--text);
  font-weight: 600;
  line-height: 1.4;
}
</style>
</head>

<body>

<div class="header">
  <h1>Pool Chemistry Calculator</h1>
  <p>LSI Balance & Dosage Recommendations</p>
</div>

<div class="app">

  <!-- Global Settings -->
  <div class="card" style="margin-bottom: 12px;">
    <h2>Pool Settings</h2>
    <div class="row">
      <div class="input-group">
        <label>Pool Volume (gallons)</label>
        <input id="poolVolume" type="number" value="20000" min="1000" step="1000">
      </div>
      <div class="input-group">
        <label>Temperature Unit</label>
        <select id="unit">
          <option value="F">°F (Fahrenheit)</option>
          <option value="C">°C (Celsius)</option>
        </select>
      </div>
    </div>
  </div>
  <div class="info-blurb">
    Input your current pool chemistry readings and change the target settings to your desired values to see results/dosages.
  </div>

  <!-- Chemistry Grid -->
  <div class="card">
    <div class="chemistry-grid-header">
      <div class="header-current">Current</div>
      <div class="header-parameter">Parameter</div>
      <div class="header-target">Target</div>
    </div>

    <!-- Temperature Row -->
    <div class="chemistry-row">
      <div class="slider-cell" data-label="Current">
        <strong id="currentTempValue" contenteditable="true" data-slider="temp">80</strong>
        <input id="temp" type="range" min="50" max="100" step="0.5" value="80">
      </div>
      <div class="parameter-label">Temp (<span id="tempUnitLabel">°F</span>)</div>
      <div class="slider-cell" data-label="Target">
        <strong id="targetTempValue" contenteditable="true" data-slider="targetTemp">80</strong>
        <input id="targetTemp" type="range" min="50" max="100" step="0.5" value="80">
      </div>
    </div>

    <!-- Alkalinity Row -->
    <div class="chemistry-row">
      <div class="slider-cell" data-label="Current">
        <strong id="currentAlkValue" contenteditable="true" data-slider="alk">90</strong>
        <input id="alk" type="range" min="0" max="300" step="5" value="90">
      </div>
      <div class="parameter-label">Alkalinity (ppm)</div>
      <div class="slider-cell" data-label="Target">
        <strong id="targetAlkValue" contenteditable="true" data-slider="targetAlk">90</strong>
        <input id="targetAlk" type="range" min="60" max="180" step="5" value="90">
      </div>
    </div>

    <!-- pH Row -->
    <div class="chemistry-row">
      <div class="slider-cell" data-label="Current">
        <strong id="currentPhValue" contenteditable="true" data-slider="ph">7.5</strong>
        <input id="ph" type="range" min="6.5" max="8.5" step="0.1" value="7.5">
      </div>
      <div class="parameter-label">pH</div>
      <div class="slider-cell" data-label="Target">
        <strong id="targetPhValue" contenteditable="true" data-slider="targetPh">7.5</strong>
        <input id="targetPh" type="range" min="7.0" max="8.0" step="0.1" value="7.5">
      </div>
    </div>

    <!-- Chlorine Row -->
    <div class="chemistry-row">
      <div class="slider-cell" data-label="Current">
        <strong id="currentChlorineValue" contenteditable="true" data-slider="chlorine">3.0</strong>
        <input id="chlorine" type="range" min="0" max="10" step="0.1" value="3">
      </div>
      <div class="parameter-label">Free Chlorine (ppm)</div>
      <div class="slider-cell" data-label="Target">
        <strong id="targetFcValue" contenteditable="true" data-slider="targetFc">3.0</strong>
        <input id="targetFc" type="range" min="0" max="10" step="0.1" value="3">
      </div>
    </div>

    <!-- Calcium Row -->
    <div class="chemistry-row">
      <div class="slider-cell" data-label="Current">
        <strong id="currentCalciumValue" contenteditable="true" data-slider="calcium">300</strong>
        <input id="calcium" type="range" min="150" max="1000" step="10" value="300">
      </div>
      <div class="parameter-label">Calcium Hardness (ppm)</div>
      <div class="slider-cell" data-label="Target">
        <strong id="targetCalciumValue" contenteditable="true" data-slider="targetCalcium">300</strong>
        <input id="targetCalcium" type="range" min="150" max="1000" step="10" value="300">
      </div>
    </div>

    <!-- CYA Row -->
    <div class="chemistry-row">
      <div class="slider-cell" data-label="Current">
        <strong id="currentCyaValue" contenteditable="true" data-slider="cya">30</strong>
        <input id="cya" type="range" min="0" max="200" step="5" value="30">
      </div>
      <div class="parameter-label">CYA (ppm)</div>
      <div class="slider-cell" data-label="Target">
        <strong id="targetCyaValue" contenteditable="true" data-slider="targetCya">30</strong>
        <input id="targetCya" type="range" min="0" max="200" step="5" value="30">
      </div>
    </div>

    <!-- Borates Row -->
    <div class="chemistry-row">
      <div class="slider-cell" data-label="Current">
        <strong id="currentBorateValue" contenteditable="true" data-slider="borate">0</strong>
        <input id="borate" type="range" min="0" max="100" step="5" value="0">
      </div>
      <div class="parameter-label">Borates (ppm)</div>
      <div class="slider-cell" data-label="Target">
        <strong id="targetBorateValue" contenteditable="true" data-slider="targetBorate">0</strong>
        <input id="targetBorate" type="range" min="0" max="100" step="5" value="0">
      </div>
    </div>

    <!-- Salt Row -->
    <div class="chemistry-row">
      <div class="slider-cell" data-label="Current">
        <strong id="currentSaltValue" contenteditable="true" data-slider="salt">0</strong>
        <input id="salt" type="range" min="0" max="5000" step="100" value="0">
      </div>
      <div class="parameter-label">Salt (ppm)</div>
      <div class="slider-cell" data-label="Target">
        <strong id="targetSaltValue" contenteditable="true" data-slider="targetSalt">0</strong>
        <input id="targetSalt" type="range" min="0" max="5000" step="100" value="0">
      </div>
    </div>

    <!-- TDS Row -->
    <div class="chemistry-row">
      <div class="slider-cell" data-label="Current">
        <strong id="currentTdsValue" contenteditable="true" data-slider="tdsBase">1000</strong>
        <input id="tdsBase" type="range" min="0" max="5000" step="100" value="1000">
      </div>
      <div class="parameter-label">Base TDS (ppm)</div>
      <div class="slider-cell" data-label="Target">
        <strong id="targetTdsValue" contenteditable="true" data-slider="targetTds">1000</strong>
        <input id="targetTds" type="range" min="0" max="5000" step="100" value="1000">
      </div>
    </div>
  </div>

  <!-- LSI Results Grid -->
  <div class="calculator-grid">
    <div class="card">
      <h2>Current LSI Status</h2>
      <div id="result" class="result-box"></div>
      <div class="bar-container">
        <div class="bar">
          <div id="barIndicator" class="bar-indicator"></div>
        </div>
        <div class="bar-labels">
          <span>-1.0<br>Corrosive</span>
          <span>0.0<br>Balanced</span>
          <span>+1.0<br>Scaling</span>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Target LSI</h2>
      <div id="targetResult" class="target-result"></div>
    </div>
  </div>

  <!-- Dosage Recommendations -->
  <div class="card dosage-card">
    <h2>Dosage Recommendations</h2>
    <div id="dosageResult"></div>
  </div>

</div>

<script>
/* LSI Calculation Functions */
function log10(x) {
  return Math.log(x) / Math.LN10;
}

function computeLsi(ph, tempVal, unit, calcium, alk, cya, borate, salt, tdsBase) {
  let tempC = tempVal;
  if (unit === "F") {
    tempC = (tempVal - 32) * 5 / 9;
  }

  const tds = Math.max((tdsBase || 0) + (salt || 0), 100);
  let adjAlk = alk - (cya * 0.33) - (borate * 0.5);
  if (adjAlk < 1) adjAlk = 1;

  const A = (log10(tds) - 1) / 10;
  const B = -13.12 * log10(tempC + 273) + 34.55;
  const C = log10(calcium) - 0.4;
  const D = log10(adjAlk);
  const pHs = (9.3 + A + B) - (C + D);
  const lsi = ph - pHs;

  return { lsi, pHs, adjAlk, tds };
}

function describeLsi(lsi) {
  if (lsi < -0.3) {
    return {
      text: "Corrosive",
      status: "status-danger",
      badge: "badge-danger",
      suggestion: "Water is corrosive. Raise pH, Total Alkalinity, or Calcium Hardness."
    };
  }
  if (lsi > 0.3) {
    return {
      text: "Scaling",
      status: "status-warning",
      badge: "badge-warning",
      suggestion: "Water is scaling. Lower pH or avoid further increases to Calcium Hardness."
    };
  }
  return {
    text: "Balanced",
    status: "status-balanced",
    badge: "badge-success",
    suggestion: "Water chemistry is balanced. Maintain current levels."
  };
}

/* Helper function to format dosage with oz/lbs/gallons */
function formatDosage(ounces, isLiquid) {
  if (isLiquid && ounces >= 128) {
    // Convert to gallons for liquids (128 oz = 1 gallon)
    const gallons = ounces / 128;
    return `${gallons.toFixed(1)} gallons`;
  } else if (!isLiquid && ounces >= 16) {
    // Convert to pounds for solids (16 oz = 1 lb)
    const pounds = ounces / 16;
    return `${pounds.toFixed(1)} lbs`;
  }
  return `${ounces.toFixed(1)} oz`;
}

/* Calculate recommended FC based on CYA and Borates */
function calculateRecommendedFC(cya, borates) {
  // Base calculation: CYA / 30 * 3 for pools (7.5% rule)
  let recommendedFC = (cya * 0.075);
  // Borates allow ~1 ppm reduction (5% rule)
  if (borates >= 30) {
    recommendedFC -= (borates * 0.05);
  }
  // Ensure minimum of 2 ppm
  return Math.max(2, recommendedFC);
}

/* Dosage Calculations (Orenda-based) - Calculate what's needed to reach target values */
function calculateDosages(currentPh, targetPh, currentAlk, targetAlk, currentCH, targetCH, poolVolume, currentLSI, targetLSI, currentFC, targetFC, currentCya, targetCya, currentBorates, targetBorates, currentSalt, targetSalt, currentTds, targetTds, currentTemp, targetTemp) {
  const dosages = [];

  // Temperature Note
  const tempDiff = targetTemp - currentTemp;
  if (Math.abs(tempDiff) > 2) {
    dosages.push({
      product: "Temperature Adjustment (Heater/Cooler)",
      amount: "N/A",
      reason: `Adjust temperature from ${currentTemp.toFixed(1)}° to ${targetTemp.toFixed(1)}°`,
      note: "Temperature cannot be adjusted chemically. Use pool heater to raise or allow natural cooling to lower."
    });
  }

  // pH Adjustment
  const phDiff = targetPh - currentPh;
  if (Math.abs(phDiff) > 0.05) {
    if (phDiff > 0) {
      // Need to raise pH - use Soda Ash (pH Up)
      // Orenda guideline: ~6 oz per 10,000 gallons raises pH by ~0.2
      const ozPer10k = (Math.abs(phDiff) / 0.2) * 6;
      const totalOz = (ozPer10k * poolVolume) / 10000;
      dosages.push({
        product: "pH Up (Soda Ash)",
        amount: formatDosage(totalOz, false),
        reason: `Raise pH from ${currentPh.toFixed(1)} to ${targetPh.toFixed(1)}`,
        note: "Add gradually, wait 4 hours, then retest. May affect alkalinity."
      });
    } else {
      // Need to lower pH - use Muriatic Acid
      // Orenda guideline: ~10 oz per 10,000 gallons lowers pH by ~0.2
      const ozPer10k = (Math.abs(phDiff) / 0.2) * 10;
      const totalOz = (ozPer10k * poolVolume) / 10000;
      dosages.push({
        product: "pH Down (Muriatic Acid 31.45%)",
        amount: formatDosage(totalOz, true),
        reason: `Lower pH from ${currentPh.toFixed(1)} to ${targetPh.toFixed(1)}`,
        note: "Add slowly near return jets with pump running. May affect alkalinity."
      });
    }
  }

  // Total Alkalinity Adjustment
  const alkDiff = targetAlk - currentAlk;
  if (Math.abs(alkDiff) > 5) {
    if (alkDiff > 0) {
      // Need to raise TA - use Sodium Bicarbonate
      // Orenda guideline: ~16 oz per 10,000 gallons raises TA by ~10 ppm
      const ozPer10k = (Math.abs(alkDiff) / 10) * 16;
      const totalOz = (ozPer10k * poolVolume) / 10000;
      dosages.push({
        product: "Alkalinity Up (Sodium Bicarbonate)",
        amount: formatDosage(totalOz, false),
        reason: `Raise TA from ${currentAlk} to ${targetAlk} ppm`,
        note: "Dissolve in bucket of water first, then add around perimeter"
      });
    } else {
      // Need to lower TA - use Muriatic Acid
      // Orenda guideline: ~10 oz per 10,000 gallons lowers TA by ~10 ppm
      const ozPer10k = (Math.abs(alkDiff) / 10) * 10;
      const totalOz = (ozPer10k * poolVolume) / 10000;
      dosages.push({
        product: "Muriatic Acid 31.45% (for TA)",
        amount: formatDosage(totalOz, true),
        reason: `Lower TA from ${currentAlk} to ${targetAlk} ppm`,
        note: "Lower TA by aerating pool and adding acid over several days"
      });
    }
  }

  // Calcium Hardness Adjustment
  const chDiff = targetCH - currentCH;
  if (Math.abs(chDiff) > 10) {
    if (chDiff > 0) {
      // Need to raise CH - use Calcium Chloride
      // Orenda guideline: ~11 oz per 10,000 gallons raises CH by ~10 ppm
      const ozPer10k = (Math.abs(chDiff) / 10) * 11;
      const totalOz = (ozPer10k * poolVolume) / 10000;
      dosages.push({
        product: "Calcium Hardness Increaser (Calcium Chloride)",
        amount: formatDosage(totalOz, false),
        reason: `Raise CH from ${currentCH} to ${targetCH} ppm`,
        note: "Dissolve completely before adding to pool"
      });
    } else {
      // Can't chemically lower CH - only recommend drain/refill if CYA > 100 AND CH > 500
      if (currentCya > 100 && currentCH > 500) {
        const gallonsToReplace = Math.ceil((Math.abs(chDiff) / currentCH) * poolVolume);
        dosages.push({
          product: "Water Replacement (Dilution)",
          amount: `${gallonsToReplace} gallons`,
          reason: `Lower CH from ${currentCH} to ${targetCH} ppm (CYA is ${currentCya} ppm)`,
          note: "Drain and refill with fresh water. This will also lower CYA. Cannot chemically lower calcium."
        });
      }
    }
  }

  // CYA (Cyanuric Acid) Adjustment
  const cyaDiff = targetCya - currentCya;
  if (Math.abs(cyaDiff) > 5) {
    if (cyaDiff > 0) {
      // Need to raise CYA - use Cyanuric Acid
      // Guideline: ~13 oz per 10,000 gallons raises CYA by ~10 ppm
      const ozPer10k = (Math.abs(cyaDiff) / 10) * 13;
      const totalOz = (ozPer10k * poolVolume) / 10000;
      dosages.push({
        product: "Cyanuric Acid (Stabilizer)",
        amount: formatDosage(totalOz, false),
        reason: `Raise CYA from ${currentCya} to ${targetCya} ppm`,
        note: "Dissolve in warm water first. Add slowly through skimmer or distribute around pool. Takes 24-48 hours to fully dissolve."
      });
    } else {
      // Need to lower CYA - can only drain/refill
      const percentToReplace = (Math.abs(cyaDiff) / currentCya) * 100;
      const gallonsToReplace = Math.ceil((percentToReplace / 100) * poolVolume);
      dosages.push({
        product: "Water Replacement (Dilution)",
        amount: `${gallonsToReplace} gallons (~${percentToReplace.toFixed(0)}% of pool)`,
        reason: `Lower CYA from ${currentCya} to ${targetCya} ppm`,
        note: "Drain and refill with fresh water. Cannot chemically lower CYA. This will also lower other dissolved solids."
      });
    }
  }

  // Free Chlorine Adjustment
  const fcDiff = targetFC - currentFC;
  if (Math.abs(fcDiff) > 0.1) {
    if (fcDiff > 0) {
      // Need to raise FC - use liquid chlorine (12.5% sodium hypochlorite)
      // Orenda guideline: ~10 oz per 10,000 gallons raises FC by ~1 ppm
      const ozPer10k = Math.abs(fcDiff) * 10;
      const totalOz = (ozPer10k * poolVolume) / 10000;
      dosages.push({
        product: "Liquid Chlorine (12.5% Sodium Hypochlorite)",
        amount: formatDosage(totalOz, true),
        reason: `Raise FC from ${currentFC.toFixed(1)} to ${targetFC.toFixed(1)} ppm`,
        note: "Add in evening or at night for best results. Retest after 8 hours."
      });
    } else {
      // FC is too high - wait for it to dissipate
      dosages.push({
        product: "No Action Needed",
        amount: "Wait",
        reason: `FC will naturally drop from ${currentFC.toFixed(1)} to ${targetFC.toFixed(1)} ppm`,
        note: "Leave pool uncovered in sunlight to speed up chlorine dissipation."
      });
    }
  }

  // Borates Adjustment
  const boratesDiff = targetBorates - currentBorates;
  if (Math.abs(boratesDiff) > 5) {
    if (boratesDiff > 0) {
      // Need to raise Borates - use Boric Acid or Borax
      // Guideline: ~75 oz of Boric Acid per 10,000 gallons raises borates by ~50 ppm
      const ozPer10k = (Math.abs(boratesDiff) / 50) * 75;
      const totalOz = (ozPer10k * poolVolume) / 10000;
      dosages.push({
        product: "Boric Acid (or 20 Mule Team Borax)",
        amount: formatDosage(totalOz, false),
        reason: `Raise Borates from ${currentBorates} to ${targetBorates} ppm`,
        note: "Dissolve in warm water first. Add slowly around pool perimeter. May take several days to fully circulate. Borates help stabilize pH."
      });
    } else {
      // Need to lower Borates - can only drain/refill
      const percentToReplace = (Math.abs(boratesDiff) / currentBorates) * 100;
      const gallonsToReplace = Math.ceil((percentToReplace / 100) * poolVolume);
      dosages.push({
        product: "Water Replacement (Dilution)",
        amount: `${gallonsToReplace} gallons (~${percentToReplace.toFixed(0)}% of pool)`,
        reason: `Lower Borates from ${currentBorates} to ${targetBorates} ppm`,
        note: "Drain and refill with fresh water. Cannot chemically lower borates."
      });
    }
  }

  // Salt Adjustment
  const saltDiff = targetSalt - currentSalt;
  if (Math.abs(saltDiff) > 100) {
    if (saltDiff > 0) {
      // Need to raise Salt - add pool salt
      // Guideline: ~8.3 lbs per 1,000 gallons raises salt by ~1,000 ppm
      const lbsPerThousand = (Math.abs(saltDiff) / 1000) * 8.3;
      const totalLbs = (lbsPerThousand * poolVolume) / 1000;
      const bags = Math.round(totalLbs / 40);
      dosages.push({
        product: "Pool Salt (Sodium Chloride)",
        amount: `${totalLbs.toFixed(1)} lbs (${bags} ${bags === 1 ? 'bag' : 'bags'})`,
        reason: `Raise Salt from ${currentSalt} to ${targetSalt} ppm`,
        note: "Add salt directly to pool with pump running. Brush to help dissolve. Takes 24 hours to fully circulate. Wait before testing."
      });
    } else {
      // Need to lower Salt - can only drain/refill
      const percentToReplace = (Math.abs(saltDiff) / currentSalt) * 100;
      const gallonsToReplace = Math.ceil((percentToReplace / 100) * poolVolume);
      dosages.push({
        product: "Water Replacement (Dilution)",
        amount: `${gallonsToReplace} gallons (~${percentToReplace.toFixed(0)}% of pool)`,
        reason: `Lower Salt from ${currentSalt} to ${targetSalt} ppm`,
        note: "Drain and refill with fresh water. Cannot chemically lower salt. This will also lower TDS."
      });
    }
  }

  // TDS Adjustment
  const tdsDiff = targetTds - currentTds;
  if (Math.abs(tdsDiff) > 100) {
    if (tdsDiff < 0) {
      // Need to lower TDS - can only drain/refill
      const percentToReplace = (Math.abs(tdsDiff) / currentTds) * 100;
      const gallonsToReplace = Math.ceil((percentToReplace / 100) * poolVolume);
      dosages.push({
        product: "Water Replacement (Dilution)",
        amount: `${gallonsToReplace} gallons (~${percentToReplace.toFixed(0)}% of pool)`,
        reason: `Lower TDS from ${currentTds} to ${targetTds} ppm`,
        note: "Drain and refill with fresh water. High TDS indicates buildup of dissolved solids. This will also lower other parameters."
      });
    }
    // TDS naturally increases - no recommendation to raise it
  }

  return dosages;
}

/* Update Functions */
function updateTargets() {
  // Update current values display
  document.getElementById("currentPhValue").textContent =
    parseFloat(document.getElementById("ph").value).toFixed(1);
  document.getElementById("currentTempValue").textContent =
    parseFloat(document.getElementById("temp").value).toFixed(1);
  document.getElementById("currentCalciumValue").textContent =
    document.getElementById("calcium").value;
  document.getElementById("currentAlkValue").textContent =
    document.getElementById("alk").value;
  document.getElementById("currentCyaValue").textContent =
    document.getElementById("cya").value;
  document.getElementById("currentChlorineValue").textContent =
    parseFloat(document.getElementById("chlorine").value).toFixed(1);
  document.getElementById("currentBorateValue").textContent =
    document.getElementById("borate").value;
  document.getElementById("currentSaltValue").textContent =
    document.getElementById("salt").value;
  document.getElementById("currentTdsValue").textContent =
    document.getElementById("tdsBase").value;

  // Update target values display
  document.getElementById("targetPhValue").textContent =
    parseFloat(document.getElementById("targetPh").value).toFixed(1);
  document.getElementById("targetTempValue").textContent =
    parseFloat(document.getElementById("targetTemp").value).toFixed(1);
  document.getElementById("targetCalciumValue").textContent =
    document.getElementById("targetCalcium").value;
  document.getElementById("targetAlkValue").textContent =
    document.getElementById("targetAlk").value;
  document.getElementById("targetCyaValue").textContent =
    document.getElementById("targetCya").value;
  document.getElementById("targetFcValue").textContent =
    parseFloat(document.getElementById("targetFc").value).toFixed(1);
  document.getElementById("targetBorateValue").textContent =
    document.getElementById("targetBorate").value;
  document.getElementById("targetSaltValue").textContent =
    document.getElementById("targetSalt").value;
  document.getElementById("targetTdsValue").textContent =
    document.getElementById("targetTds").value;
}

function calculate() {
  // Get current values
  const ph = parseFloat(phInput.value);
  const temp = parseFloat(tempInput.value);
  const unit = unitInput.value;
  const calcium = parseFloat(calciumInput.value);
  const alk = parseFloat(alkInput.value);
  const cya = parseFloat(cyaInput.value) || 0;
  const chlorine = parseFloat(chlorineInput.value) || 0;
  const borate = parseFloat(borateInput.value) || 0;
  const salt = parseFloat(saltInput.value) || 0;
  const tdsBase = parseFloat(tdsBaseInput.value) || 0;
  const poolVolume = parseFloat(poolVolumeInput.value) || 20000;

  // Calculate current LSI
  const current = computeLsi(ph, temp, unit, calcium, alk, cya, borate, salt, tdsBase);
  const desc = describeLsi(current.lsi);

  // Calculate recommended chlorine
  const recommendedFC = calculateRecommendedFC(cya, borate);
  const fcStatus = chlorine >= recommendedFC - 0.5 && chlorine <= recommendedFC + 2 ?
    '<span style="color: var(--success)">✓ Good</span>' :
    '<span style="color: var(--warning)">⚠ Adjust</span>';

  // Display current LSI
  resultDiv.innerHTML = `
    <div class="lsi-value ${desc.status}">${current.lsi.toFixed(2)}</div>
    <div class="lsi-status ${desc.status}">${desc.text}</div>
    <div class="lsi-details">
      pHs: ${current.pHs.toFixed(2)} |
      Adj. Alkalinity: ${current.adjAlk.toFixed(0)} ppm<br>
      FC: ${chlorine.toFixed(1)} ppm | Target: ${recommendedFC.toFixed(1)} ppm ${fcStatus}
    </div>
    <div class="info-badge ${desc.badge}">${desc.suggestion}</div>
  `;

  // Update bar indicator
  const pct = ((Math.max(-1, Math.min(1, current.lsi)) + 1) / 2) * 100;
  barIndicator.style.left = pct + "%";

  // Update target values display
  updateTargets();
  const tPh = parseFloat(targetPh.value);
  const tTemp = parseFloat(targetTemp.value);
  const tCH = parseFloat(targetCalcium.value);
  const tTA = parseFloat(targetAlk.value);
  const tCYA = parseFloat(targetCya.value);
  const tFC = parseFloat(targetFc.value);
  const tBorate = parseFloat(targetBorate.value);
  const tSalt = parseFloat(targetSalt.value);
  const tTds = parseFloat(targetTds.value);

  // Calculate target LSI using target values
  const targ = computeLsi(tPh, tTemp, unit, tCH, tTA, tCYA, tBorate, tSalt, tTds);
  const tDesc = describeLsi(targ.lsi);

  // Display target LSI
  targetResult.innerHTML = `
    <div class="target-lsi ${tDesc.status}">${targ.lsi.toFixed(2)}</div>
    <div class="target-status ${tDesc.status}">${tDesc.text}</div>
    <div class="info-badge ${tDesc.badge}" style="background: #fff;">${tDesc.suggestion}</div>
  `;

  // Calculate and display dosages
  const dosages = calculateDosages(ph, tPh, alk, tTA, calcium, tCH, poolVolume, current.lsi, targ.lsi, chlorine, tFC, cya, tCYA, borate, tBorate, salt, tSalt, tdsBase, tTds, temp, tTemp);

  if (dosages.length === 0) {
    dosageResult.innerHTML = `
      <div class="no-dosage">
        <strong>✓ No chemical adjustments needed!</strong><br>
        Current values match target values.
      </div>
    `;
  } else {
    let dosageHtml = dosages.map(d => `
      <div class="dosage-item">
        <h4>${d.product}</h4>
        <div class="dosage-amount">${d.amount}</div>
        <div style="font-size: 0.875rem; color: var(--text-light); margin: 4px 0;">
          ${d.reason}
        </div>
        <div class="dosage-note">${d.note}</div>
      </div>
    `).join('');

    dosageResult.innerHTML = dosageHtml;
  }

  // Update temp unit label
  document.getElementById("tempUnitLabel").textContent = unit === "F" ? "°F" : "°C";
}

/* Initialize */
const phInput = document.getElementById("ph");
const tempInput = document.getElementById("temp");
const unitInput = document.getElementById("unit");
const calciumInput = document.getElementById("calcium");
const alkInput = document.getElementById("alk");
const cyaInput = document.getElementById("cya");
const chlorineInput = document.getElementById("chlorine");
const borateInput = document.getElementById("borate");
const saltInput = document.getElementById("salt");
const tdsBaseInput = document.getElementById("tdsBase");
const poolVolumeInput = document.getElementById("poolVolume");
const resultDiv = document.getElementById("result");
const barIndicator = document.getElementById("barIndicator");
const targetPh = document.getElementById("targetPh");
const targetTemp = document.getElementById("targetTemp");
const targetCalcium = document.getElementById("targetCalcium");
const targetAlk = document.getElementById("targetAlk");
const targetCya = document.getElementById("targetCya");
const targetFc = document.getElementById("targetFc");
const targetBorate = document.getElementById("targetBorate");
const targetSalt = document.getElementById("targetSalt");
const targetTds = document.getElementById("targetTds");
const targetResult = document.getElementById("targetResult");
const dosageResult = document.getElementById("dosageResult");

// Bind all inputs
const elements = [
  "ph", "temp", "unit", "calcium", "alk", "cya", "chlorine", "borate", "salt", "tdsBase", "poolVolume",
  "targetPh", "targetTemp", "targetCalcium", "targetAlk", "targetCya", "targetFc", "targetBorate", "targetSalt", "targetTds"
];

elements.forEach(id => {
  document.getElementById(id).addEventListener("input", calculate);
});

// Add special handler for salt slider to update TDS
document.getElementById("salt").addEventListener("input", function() {
  const saltValue = parseInt(this.value);
  const tdsSlider = document.getElementById("tdsBase");
  const currentTds = parseInt(tdsSlider.value);

  // Update TDS to match salt if salt is higher
  if (saltValue > currentTds) {
    tdsSlider.value = saltValue;
    // Recalculate with the corrected TDS
    calculate();
  }
});

// Add special handler for target salt slider to update target TDS
document.getElementById("targetSalt").addEventListener("input", function() {
  const saltValue = parseInt(this.value);
  const tdsSlider = document.getElementById("targetTds");
  const currentTds = parseInt(tdsSlider.value);

  // Update TDS to match salt if salt is higher
  if (saltValue > currentTds) {
    tdsSlider.value = saltValue;
    // Recalculate with the corrected target TDS
    calculate();
  }
});

// Add validation for TDS slider - cannot be lower than salt
document.getElementById("tdsBase").addEventListener("input", function(e) {
  const tdsValue = parseInt(this.value);
  const saltSlider = document.getElementById("salt");
  const saltValue = parseInt(saltSlider.value);

  // If TDS is lower than salt, revert and flash red
  if (tdsValue < saltValue) {
    this.value = saltValue;
    this.classList.add('flash-error');
    setTimeout(() => {
      this.classList.remove('flash-error');
    }, 400);
    // Force update display with corrected value
    document.getElementById("currentTdsValue").textContent = saltValue;
    // Recalculate with locked value
    calculate();
  }
});

// Add validation for target TDS slider - cannot be lower than target salt
document.getElementById("targetTds").addEventListener("input", function(e) {
  const tdsValue = parseInt(this.value);
  const saltSlider = document.getElementById("targetSalt");
  const saltValue = parseInt(saltSlider.value);

  // If TDS is lower than salt, revert and flash red
  if (tdsValue < saltValue) {
    this.value = saltValue;
    this.classList.add('flash-error');
    setTimeout(() => {
      this.classList.remove('flash-error');
    }, 400);
    // Force update display with corrected value
    document.getElementById("targetTdsValue").textContent = saltValue;
    // Recalculate with locked target value
    calculate();
  }
});

// Make value labels editable and sync back to sliders
document.querySelectorAll('.slider-label strong[contenteditable]').forEach(label => {
  // Store original value on focus
  label.addEventListener('focus', function() {
    this.dataset.oldValue = this.textContent;
    // Select all text on focus
    const range = document.createRange();
    range.selectNodeContents(this);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
  });

  // Handle blur event (when user clicks away)
  label.addEventListener('blur', function() {
    processEditedValue(this);
  });

  // Handle Enter key to commit changes
  label.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      this.blur();
    }
    // Escape key to cancel
    if (e.key === 'Escape') {
      e.preventDefault();
      this.textContent = this.dataset.oldValue;
      this.blur();
    }
  });
});

function processEditedValue(label) {
  const sliderId = label.dataset.slider;
  const slider = document.getElementById(sliderId);

  if (!slider) return;

  // Parse the entered value
  const raw = label.textContent.trim();
  if (raw === "") {
    return;
  }

  let newValue = parseFloat(raw);

  // Validate the value
  const min = parseFloat(slider.min);
  const max = parseFloat(slider.max);
  const step = parseFloat(slider.step);

  if (isNaN(newValue)) {
    // Invalid input, revert to slider value
    newValue = parseFloat(slider.value);
  } else {
    // Clamp to min/max
    newValue = Math.max(min, Math.min(max, newValue));

    // Round to step
    newValue = Math.round(newValue / step) * step;

    // Special validation for TDS - must be >= salt
    if (sliderId === 'tdsBase') {
      const saltValue = parseInt(document.getElementById('salt').value);
      if (newValue < saltValue) {
        newValue = saltValue;
        slider.classList.add('flash-error');
        setTimeout(() => {
          slider.classList.remove('flash-error');
        }, 400);
      }
    }
    if (sliderId === 'targetTds') {
      const saltValue = parseInt(document.getElementById('targetSalt').value);
      if (newValue < saltValue) {
        newValue = saltValue;
        slider.classList.add('flash-error');
        setTimeout(() => {
          slider.classList.remove('flash-error');
        }, 400);
      }
    }
  }

  // Update slider value
  slider.value = newValue;

  // Trigger calculate to update everything
  calculate();
}

// Live-sync slider when typing in the value pills
document.querySelectorAll('.slider-cell strong[contenteditable]').forEach(label => {
  label.addEventListener('input', function() {
    processEditedValue(this);
  });
});

// Initial calculation
calculate();
</script>

</body>
</html>
